{"filter":false,"title":"lambda.tf","tooltip":"/eksamen-2024/infra/lambda.tf","undoManager":{"mark":8,"position":8,"stack":[[{"start":{"row":0,"column":0},"end":{"row":63,"column":0},"action":"insert","lines":["# Opprett SQS-kø","resource \"aws_sqs_queue\" \"image_processing_queue\" {","  name                        = \"image-processing-queue\"","  visibility_timeout_seconds  = 30 # Maks behandlingstid for Lambda","}","","# IAM-rolle for Lambda","resource \"aws_iam_role\" \"lambda_execution_role\" {","  name = \"lambda-execution-role\"","","  assume_role_policy = jsonencode({","    Version = \"2012-10-17\"","    Statement = [","      {","        Action    = \"sts:AssumeRole\"","        Effect    = \"Allow\"","        Principal = {","          Service = \"lambda.amazonaws.com\"","        }","      }","    ]","  })","}","","# IAM-policy for tilgang til SQS, S3 og logging","resource \"aws_iam_role_policy\" \"lambda_policy\" {","  name = \"lambda-sqs-s3-policy\"","  role = aws_iam_role.lambda_execution_role.id","","  policy = jsonencode({","    Version = \"2012-10-17\"","    Statement = [","      # SQS-tilgang","      {","        Action = [","          \"sqs:ReceiveMessage\",","          \"sqs:DeleteMessage\",","          \"sqs:GetQueueAttributes\"","        ]","        Effect   = \"Allow\"","        Resource = aws_sqs_queue.image_processing_queue.arn","      },","      # S3-tilgang","      {","        Action = [","          \"s3:PutObject\"","        ]","        Effect   = \"Allow\"","        Resource = \"arn:aws:s3:::pgr301-couch-explorers/*\"","      },","      # Logging-tilgang","      {","        Action = [","          \"logs:CreateLogGroup\",","          \"logs:CreateLogStream\",","          \"logs:PutLogEvents\"","        ]","        Effect = \"Allow\"","        Resource = \"arn:aws:logs:*:*:*\"","      }","    ]","  })","}",""],"id":1}],[{"start":{"row":0,"column":0},"end":{"row":63,"column":0},"action":"remove","lines":["# Opprett SQS-kø","resource \"aws_sqs_queue\" \"image_processing_queue\" {","  name                        = \"image-processing-queue\"","  visibility_timeout_seconds  = 30 # Maks behandlingstid for Lambda","}","","# IAM-rolle for Lambda","resource \"aws_iam_role\" \"lambda_execution_role\" {","  name = \"lambda-execution-role\"","","  assume_role_policy = jsonencode({","    Version = \"2012-10-17\"","    Statement = [","      {","        Action    = \"sts:AssumeRole\"","        Effect    = \"Allow\"","        Principal = {","          Service = \"lambda.amazonaws.com\"","        }","      }","    ]","  })","}","","# IAM-policy for tilgang til SQS, S3 og logging","resource \"aws_iam_role_policy\" \"lambda_policy\" {","  name = \"lambda-sqs-s3-policy\"","  role = aws_iam_role.lambda_execution_role.id","","  policy = jsonencode({","    Version = \"2012-10-17\"","    Statement = [","      # SQS-tilgang","      {","        Action = [","          \"sqs:ReceiveMessage\",","          \"sqs:DeleteMessage\",","          \"sqs:GetQueueAttributes\"","        ]","        Effect   = \"Allow\"","        Resource = aws_sqs_queue.image_processing_queue.arn","      },","      # S3-tilgang","      {","        Action = [","          \"s3:PutObject\"","        ]","        Effect   = \"Allow\"","        Resource = \"arn:aws:s3:::pgr301-couch-explorers/*\"","      },","      # Logging-tilgang","      {","        Action = [","          \"logs:CreateLogGroup\",","          \"logs:CreateLogStream\",","          \"logs:PutLogEvents\"","        ]","        Effect = \"Allow\"","        Resource = \"arn:aws:logs:*:*:*\"","      }","    ]","  })","}",""],"id":2}],[{"start":{"row":0,"column":0},"end":{"row":24,"column":0},"action":"insert","lines":["# Lambda-funksjonen","resource \"aws_lambda_function\" \"image_processor\" {","  function_name    = \"image-processor-lambda\"","  role             = aws_iam_role.lambda_execution_role.arn","  handler          = \"lambda_sqs.lambda_handler\"","  runtime          = \"python3.9\"","  timeout          = 30 # Timeout matcher SQS visibility timeout","  source_code_hash = filebase64sha256(\"lambda_sqs.zip\") # Referer til ZIP-filen","","  filename         = \"lambda_sqs.zip\" # Last opp ZIP-filen her","  environment {","    variables = {","      BUCKET_NAME = \"pgr301-couch-explorers\" # Miljøvariabel for bucket","    }","  }","}","","# SQS til Lambda-integrasjon","resource \"aws_lambda_event_source_mapping\" \"sqs_to_lambda\" {","  event_source_arn = aws_sqs_queue.image_processing_queue.arn","  function_name    = aws_lambda_function.image_processor.arn","  batch_size       = 5","  enabled          = true","}",""],"id":3}],[{"start":{"row":0,"column":0},"end":{"row":15,"column":1},"action":"remove","lines":["# Lambda-funksjonen","resource \"aws_lambda_function\" \"image_processor\" {","  function_name    = \"image-processor-lambda\"","  role             = aws_iam_role.lambda_execution_role.arn","  handler          = \"lambda_sqs.lambda_handler\"","  runtime          = \"python3.9\"","  timeout          = 30 # Timeout matcher SQS visibility timeout","  source_code_hash = filebase64sha256(\"lambda_sqs.zip\") # Referer til ZIP-filen","","  filename         = \"lambda_sqs.zip\" # Last opp ZIP-filen her","  environment {","    variables = {","      BUCKET_NAME = \"pgr301-couch-explorers\" # Miljøvariabel for bucket","    }","  }","}"],"id":14},{"start":{"row":0,"column":0},"end":{"row":17,"column":0},"action":"insert","lines":["# Lambda-funksjonen","resource \"aws_lambda_function\" \"image_processor\" {","  function_name = \"image-processor-lambda\"","  role          = aws_iam_role.lambda_execution_role.arn","  handler       = \"lambda_sqs.lambda_handler\"","  runtime       = \"python3.9\"","  timeout       = 30","","  # Peker til Python-filen direkte","  filename = \"lambda_sqs.py\"","","  environment {","    variables = {","      BUCKET_NAME = \"pgr301-couch-explorers\"","    }","  }","}",""]}],[{"start":{"row":16,"column":1},"end":{"row":17,"column":0},"action":"remove","lines":["",""],"id":15}],[{"start":{"row":20,"column":57},"end":{"row":20,"column":58},"action":"insert","lines":["_"],"id":16},{"start":{"row":20,"column":58},"end":{"row":20,"column":59},"action":"insert","lines":["2"]},{"start":{"row":20,"column":59},"end":{"row":20,"column":60},"action":"insert","lines":["7"]}],[{"start":{"row":3,"column":18},"end":{"row":3,"column":56},"action":"remove","lines":["aws_iam_role.lambda_execution_role.arn"],"id":17},{"start":{"row":3,"column":18},"end":{"row":3,"column":71},"action":"insert","lines":["arn:aws:iam::244530008913:role/service-role/myRole-27"]}],[{"start":{"row":3,"column":18},"end":{"row":3,"column":19},"action":"insert","lines":["\""],"id":18}],[{"start":{"row":3,"column":72},"end":{"row":3,"column":73},"action":"insert","lines":["\""],"id":19}]]},"ace":{"folds":[],"scrolltop":0,"scrollleft":0,"selection":{"start":{"row":2,"column":42},"end":{"row":2,"column":42},"isBackwards":true},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":0},"timestamp":1732369819112,"hash":"a0ed50696aa82aa721f195b5bf794f42d3312617"}